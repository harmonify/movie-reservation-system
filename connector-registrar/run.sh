#!/bin/bash

set -euo pipefail

check_env() {
	if [ -z "$1" ]; then
		echo "The $2 environment variable is not set. Exiting."
		exit 1
	fi
}

check_env "$CONNECT_URL" "CONNECT_URL"
check_env "$SCHEMA_REGISTRY_URL" "SCHEMA_REGISTRY_URL"
check_env "$USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_CONNECTOR_NAME" "USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_CONNECTOR_NAME"
check_env "$USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_HOST" "USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_HOST"
check_env "$USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_PORT" "USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_PORT"
check_env "$USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_USER" "USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_USER"
check_env "$USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_PASSWORD" "USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_PASSWORD"
check_env "$USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_NAME" "USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_NAME"
check_env "$USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_SCHEMA" "USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_SCHEMA"
check_env "$USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_TABLE" "USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_DB_TABLE"
check_env "$USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_TOPIC_NAME_TEMPLATE" "USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_TOPIC_NAME_TEMPLATE"
check_env "$USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_RUN_MIGRATION" "USER_SERVICE_OUTBOX_POSTGRESQL_SOURCE_RUN_MIGRATION"
check_env "$MOVIE_SERVICE_MOVIES_MONGODB_SOURCE_CONNECTOR_NAME" "MOVIE_SERVICE_MOVIES_MONGODB_SOURCE_CONNECTOR_NAME"
check_env "$MOVIE_SERVICE_MOVIES_MONGODB_SOURCE_MONGO_DATABASE_NAME" "MOVIE_SERVICE_MOVIES_MONGODB_SOURCE_MONGO_DATABASE_NAME"
check_env "$MOVIE_SERVICE_MOVIES_MONGODB_SOURCE_MONGO_CONNECTION_STRING" "MOVIE_SERVICE_MOVIES_MONGODB_SOURCE_MONGO_CONNECTION_STRING"
check_env "$MOVIE_SERVICE_MOVIES_MONGODB_SOURCE_MONGO_COLLECTION_NAME" "MOVIE_SERVICE_MOVIES_MONGODB_SOURCE_MONGO_COLLECTION_NAME"
check_env "$MOVIE_SERVICE_MOVIES_MONGODB_SOURCE_RUN_MIGRATION" "MOVIE_SERVICE_MOVIES_MONGODB_SOURCE_RUN_MIGRATION"
check_env "$MOVIE_SEARCH_SERVICE_ELASTICSEARCH_SINK_CONNECTOR_NAME" "MOVIE_SEARCH_SERVICE_ELASTICSEARCH_SINK_CONNECTOR_NAME"
check_env "$MOVIE_SEARCH_SERVICE_ELASTICSEARCH_SINK_ELASTICSEARCH_CONNECTION_URL" "MOVIE_SEARCH_SERVICE_ELASTICSEARCH_SINK_ELASTICSEARCH_CONNECTION_URL"
check_env "$MOVIE_SEARCH_SERVICE_ELASTICSEARCH_SINK_ELASTICSEARCH_USERNAME" "MOVIE_SEARCH_SERVICE_ELASTICSEARCH_SINK_ELASTICSEARCH_USERNAME"
check_env "$MOVIE_SEARCH_SERVICE_ELASTICSEARCH_SINK_ELASTICSEARCH_INDEX_NAME" "MOVIE_SEARCH_SERVICE_ELASTICSEARCH_SINK_ELASTICSEARCH_INDEX_NAME"
check_env "$MOVIE_SEARCH_SERVICE_ELASTICSEARCH_SINK_RUN_MIGRATION" "MOVIE_SEARCH_SERVICE_ELASTICSEARCH_SINK_RUN_MIGRATION"

CURR_DIR="$(dirname "$0")"

"$CURR_DIR/register_outbox_user_service_postgresql_source_connector.sh"
"$CURR_DIR/register_movies_movie_service_mongodb_source_connector.sh"
"$CURR_DIR/register_movies_movie_search_service_elasticsearch_sink_connector.sh"
